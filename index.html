<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Game Bấm Chuông</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    .hidden { display: none; }
    button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    #status { margin: 20px; font-size: 20px; font-weight: bold; }
    #questionBox { font-size: 24px; margin: 20px; }
  </style>
</head>
<body>
  <h1>📢 Game Bấm Chuông</h1>

  <div id="roleSelect">
    <button onclick="chooseRole('teacher')">Tôi là Giáo viên</button>
    <button onclick="chooseRole('student')">Tôi là Học sinh</button>
  </div>

  <!-- Giáo viên -->
  <div id="teacherUI" class="hidden">
    <h2>👩‍🏫 Giáo viên</h2>
    <button onclick="createRoom()">Tạo phòng</button>
    <input id="teacherRoomId" placeholder="Mã phòng" readonly>
    <div id="teacherControls" class="hidden">
      <button onclick="startRound()">BẮT ĐẦU</button>
      <button onclick="markCorrect()">✅ Đúng</button>
      <button onclick="markWrong()">❌ Sai</button>
      <button onclick="resetGame()">RESET</button>
      <div id="status"></div>
    </div>
  </div>

  <!-- Học sinh -->
  <div id="studentUI" class="hidden">
    <h2>👨‍🎓 Học sinh</h2>
    <input id="roomInput" placeholder="Nhập mã phòng">
    <input id="playerName" placeholder="Tên của bạn">
    <button onclick="joinRoom()">Vào phòng</button>
    <div id="studentControls" class="hidden">
      <button id="buzzBtn" onclick="buzz()">🔔 Bấm Chuông</button>
      <div id="questionBox"></div>
      <div id="status"></div>
    </div>
  </div>

  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update, push, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    // Cấu hình Firebase của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyAAdt8pjiOTBCFuDEv_1BWZlPQYtJBWdZY",
      authDomain: "appchuong-c3fb8.firebaseapp.com",
      projectId: "appchuong-c3fb8",
      storageBucket: "appchuong-c3fb8.firebasestorage.app",
      messagingSenderId: "794046720932",
      appId: "1:794046720932:web:8fe3166394b7e366dbaf31",
      measurementId: "G-1W7BYFTQNX",
      databaseURL: "https://appchuong-c3fb8-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let role = null;
    let currentRoomId = null;
    let playerId = null;
    let playerName = null;

    // Chọn vai trò
    window.chooseRole = (r) => {
      role = r;
      document.getElementById("roleSelect").classList.add("hidden");
      if (r === "teacher") {
        document.getElementById("teacherUI").classList.remove("hidden");
      } else {
        document.getElementById("studentUI").classList.remove("hidden");
      }
    };

    // Giáo viên tạo phòng
    window.createRoom = () => {
      const roomId = Math.floor(1000 + Math.random() * 9000).toString();
      set(ref(db, "rooms/" + roomId), {
        state: {
          canBuzz: false,
          winnerId: null,
          winnerName: null,
          question: null,
          currentPlayer: null
        },
        players: {}
      });
      currentRoomId = roomId;
      document.getElementById("teacherRoomId").value = roomId;
      document.getElementById("teacherControls").classList.remove("hidden");
      listenRoom(roomId);
    };

    // Học sinh vào phòng
    window.joinRoom = async () => {
      const roomId = document.getElementById("roomInput").value.trim();
      const name = document.getElementById("playerName").value.trim();
      if (!roomId || !name) return alert("Nhập mã phòng và tên");

      const snap = await get(ref(db, "rooms/" + roomId));
      if (!snap.exists()) return alert("Phòng không tồn tại");

      currentRoomId = roomId;
      playerId = push(child(ref(db), "tmp")).key;

      // Xử lý trùng tên
      const players = snap.val().players || {};
      let finalName = name;
      let count = 0;
      Object.values(players).forEach(p => {
        if (p.name.startsWith(name)) count++;
      });
      if (count > 0) finalName = `${name} ${count + 1}`;
      playerName = finalName;

      await set(ref(db, "rooms/" + roomId + "/players/" + playerId), {
        name: playerName
      });

      document.getElementById("studentControls").classList.remove("hidden");
      listenRoom(roomId);
    };

    // Giáo viên bắt đầu vòng
    window.startRound = () => {
      if (!currentRoomId) return;
      const a = Math.floor(Math.random() * 6);
      let b;
      do { b = Math.floor(Math.random() * 6); } while (b === a);

      update(ref(db, "rooms/" + currentRoomId + "/state"), {
        canBuzz: true,
        winnerId: null,
        winnerName: null,
        currentPlayer: null,
        question: { a, b }
      });
    };

    // Học sinh bấm chuông
    window.buzz = () => {
      if (!currentRoomId || !playerId) return;
      const questionRef = ref(db, "rooms/" + currentRoomId + "/state/question");
      get(questionRef).then(snap => {
        if (!snap.exists()) return;
        const q = snap.val();
        const ans = prompt(`${q.a} + ${q.b} = ?`);
        if (ans && parseInt(ans) === q.a + q.b) {
          const stateRef = ref(db, "rooms/" + currentRoomId + "/state");
          get(stateRef).then(s => {
            const st = s.val();
            if (st.canBuzz && !st.winnerId) {
              update(stateRef, {
                winnerId: playerId,
                winnerName: playerName,
                canBuzz: false,
                currentPlayer: playerId
              });
            }
          });
        } else {
          alert("Sai rồi!");
        }
      });
    };

    // Giáo viên đánh dấu đúng
    window.markCorrect = () => {
      if (!currentRoomId) return;
      document.getElementById("status").innerText = "✅ Câu trả lời đúng!";
    };

    // Giáo viên đánh dấu sai -> mở mini round
    window.markWrong = () => {
      if (!currentRoomId) return;
      startRound(); // tạo phép toán mới cho mini round
    };

    // Giáo viên reset
    window.resetGame = () => {
      if (!currentRoomId) return;
      update(ref(db, "rooms/" + currentRoomId + "/state"), {
        canBuzz: false,
        winnerId: null,
        winnerName: null,
        currentPlayer: null,
        question: null
      });
      document.getElementById("status").innerText = "";
    };

    // Lắng nghe phòng
    function listenRoom(roomId) {
      onValue(ref(db, "rooms/" + roomId + "/state"), snap => {
        if (!snap.exists()) return;
        const st = snap.val();

        // Hiển thị câu hỏi cho học sinh
        if (role === "student") {
          const qb = document.getElementById("questionBox");
          if (st.question) {
            qb.innerText = `${st.question.a} + ${st.question.b} = ?`;
          } else {
            qb.innerText = "";
          }
        }

        // Hiển thị trạng thái chung
        if (st.winnerName) {
          document.getElementById("status").innerText = `🏆 ${st.winnerName} chiến thắng!`;
        }
      });
    }
  </script>
</body>
</html>
