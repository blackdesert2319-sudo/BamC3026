<!DOCTYPE html>
<html>
<head>
    <title>Ứng dụng Bấm Chuông</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
            background-color: #f0f0f0;
        }
        #initial-screen {
            display: block;
        }
        #game-screen {
            display: none;
        }
        .button-container {
            margin-top: 50px;
        }
        .bell-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: #ff4d4d; /* Red color */
            border: none;
            box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            outline: none;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        .bell-button:active {
            transform: translateY(4px);
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
        }
        .bell-button.disabled {
            background-color: #ccc; /* Gray color */
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            cursor: not-allowed;
        }
        .bell-button.ringing {
            animation: ring-animation 0.3s infinite alternate;
        }
        @keyframes ring-animation {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        #winner-display {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div id="initial-screen">
    <h1>Ứng dụng Bấm Chuông</h1>
    <p>Nhập tên và số người để tham gia</p>
    <label for="playerName">Tên của bạn:</label><br>
    <input type="text" id="playerName" name="playerName"><br><br>

    <label for="groupSize">Số người chơi trong nhóm:</label><br>
    <input type="number" id="groupSize" name="groupSize" value="2" min="2"><br><br>

    <button id="joinButton">Tham gia</button>

    <div id="statusMessage" style="margin-top: 20px;"></div>
</div>

<div id="game-screen">
    <div id="winner-display"></div>
    <div class="button-container">
        <button id="bellButton" class="bell-button">Bấm Chuông</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDjhVqrW8avY2z2O5DyOBniE0IMbWGNQRo",
        authDomain: "bamchuong2026.firebaseapp.com",
        projectId: "bamchuong2026",
        storageBucket: "bamchuong2026.firebasestorage.app",
        messagingSenderId: "962555043612",
        appId: "1:962555043612:web:271885084f96c9c088a4d9",
        measurementId: "G-W1ZHMRW2WL"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const initialScreen = document.getElementById('initial-screen');
    const gameScreen = document.getElementById('game-screen');
    const joinButton = document.getElementById('joinButton');
    const playerNameInput = document.getElementById('playerName');
    const groupSizeInput = document.getElementById('groupSize');
    const statusMessage = document.getElementById('statusMessage');
    const bellButton = document.getElementById('bellButton');
    const winnerDisplay = document.getElementById('winner-display');

    let myName = '';
    let groupRoomId = '';
    let groupSize = 0;

    joinButton.addEventListener('click', () => {
        myName = playerNameInput.value;
        groupSize = parseInt(groupSizeInput.value);
        if (myName.trim() === '' || groupSize < 2) {
            alert('Vui lòng nhập tên và số người chơi hợp lệ.');
            return;
        }

        initialScreen.style.display = 'none';
        statusMessage.textContent = 'Đang ghép nhóm...';
        statusMessage.style.display = 'block';

        // Logic to find or create a group room
        database.ref('rooms').once('value').then(snapshot => {
            let foundRoom = false;
            snapshot.forEach(childSnapshot => {
                const room = childSnapshot.val();
                if (room.groupSize === groupSize && room.players.length < groupSize && !room.gameActive) {
                    groupRoomId = childSnapshot.key;
                    const playersRef = database.ref(`rooms/${groupRoomId}/players`);
                    playersRef.push({ name: myName, timestamp: Date.now() });
                    foundRoom = true;
                }
            });

            if (!foundRoom) {
                groupRoomId = 'room_' + Date.now();
                database.ref(`rooms/${groupRoomId}`).set({
                    groupSize: groupSize,
                    players: [{ name: myName, timestamp: Date.now() }],
                    gameActive: false,
                    winner: null
                });
            }

            // Listen for changes in the room
            database.ref(`rooms/${groupRoomId}`).on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                if (room.players && room.players.length >= room.groupSize && !room.gameActive) {
                    statusMessage.style.display = 'none';
                    initialScreen.style.display = 'none';
                    gameScreen.style.display = 'block';
                    database.ref(`rooms/${groupRoomId}/gameActive`).set(true);
                    winnerDisplay.textContent = 'Sẵn sàng! Bấm chuông giành quyền trả lời';
                }

                if (room.winner) {
                    if (room.winner.name === myName) {
                        winnerDisplay.textContent = 'Bạn đã thắng!';
                        bellButton.classList.add('ringing');
                        // Thêm âm thanh tại đây
                    } else {
                        winnerDisplay.textContent = `Người thắng: ${room.winner.name}`;
                        bellButton.classList.add('disabled');
                    }

                    setTimeout(() => {
                        if (room.winner.name === myName) {
                            resetGame();
                        }
                    }, 3000); // Reset sau 3 giây
                } else {
                     // Trạng thái reset
                     bellButton.classList.remove('disabled');
                     bellButton.classList.remove('ringing');
                     winnerDisplay.textContent = 'Sẵn sàng! Bấm chuông giành quyền trả lời';
                }
            });
        });
    });

    bellButton.addEventListener('click', () => {
        if (!bellButton.classList.contains('disabled')) {
            const winnerRef = database.ref(`rooms/${groupRoomId}/winner`);
            winnerRef.set({ name: myName, timestamp: Date.now() });
        }
    });

    function resetGame() {
        database.ref(`rooms/${groupRoomId}/winner`).set(null);
    }
</script>
</body>
</html>