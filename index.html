<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tr√≤ ch∆°i b·∫•m chu√¥ng</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #controls { margin: 20px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    #questionPopup {
      display: none;
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white; border: 2px solid black; padding: 20px;
    }
  </style>
</head>
<body>
  <h1>Game B·∫•m Chu√¥ng</h1>

  <div id="controls">
    <input type="text" id="roomId" placeholder="M√£ ph√≤ng">
    <input type="text" id="playerName" placeholder="T√™n b·∫°n">
    <br>
    <button id="createRoom">T·∫°o ph√≤ng</button>
    <button id="joinRoom">V√†o ph√≤ng</button>
    <button id="startGame">B·∫Øt ƒë·∫ßu</button>
  </div>

  <h2 id="status">Ch∆∞a v√†o ph√≤ng</h2>
  <button id="buzzBtn" disabled>üîî B·∫•m chu√¥ng</button>

  <div id="questionPopup">
    <p id="questionText"></p>
    <input type="number" id="answerInput">
    <button id="submitAnswer">Tr·∫£ l·ªùi</button>
  </div>

  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // Config Firebase c·ªßa b·∫°n
    const firebaseConfig = {
      apiKey: "AIzaSyAAdt8pjiOTBCFuDEv_1BWZlPQYtJBWdZY",
      authDomain: "appchuong-c3fb8.firebaseapp.com",
      databaseURL: "https://appchuong-c3fb8-default-rtdb.firebaseio.com",
      projectId: "appchuong-c3fb8",
      storageBucket: "appchuong-c3fb8.appspot.com",
      messagingSenderId: "794046720932",
      appId: "1:794046720932:web:8fe3166394b7e366dbaf31"
    };

    // Kh·ªüi t·∫°o
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentRoom = "";
    let playerName = "";
    let canBuzz = false;
    let correctAnswer = null;

    // T·∫°o ph√≤ng
    document.getElementById("createRoom").onclick = async () => {
      const room = document.getElementById("roomId").value;
      if (!room) return alert("Nh·∫≠p m√£ ph√≤ng");
      await set(ref(db, "rooms/" + room), {
        started: false,
        winner: "",
        question: null
      });
      currentRoom = room;
      playerName = document.getElementById("playerName").value;
      document.getElementById("status").innerText = "ƒê√£ t·∫°o ph√≤ng " + room;
    };

    // V√†o ph√≤ng
    document.getElementById("joinRoom").onclick = async () => {
      const room = document.getElementById("roomId").value;
      if (!room) return alert("Nh·∫≠p m√£ ph√≤ng");
      currentRoom = room;
      playerName = document.getElementById("playerName").value;
      document.getElementById("status").innerText = "ƒê√£ v√†o ph√≤ng " + room;
      // Theo d√µi tr·∫°ng th√°i ph√≤ng
      onValue(ref(db, "rooms/" + room), snapshot => {
        const data = snapshot.val();
        if (!data) return;
        if (data.started) {
          document.getElementById("buzzBtn").disabled = false;
          canBuzz = true;
        } else {
          document.getElementById("buzzBtn").disabled = true;
          canBuzz = false;
        }
        if (data.question) {
          correctAnswer = data.question.ans;
          showQuestion(data.question.text);
        }
        if (data.winner) {
          document.getElementById("status").innerText = "Ng∆∞·ªùi b·∫•m tr∆∞·ªõc: " + data.winner;
        }
      });
    };

    // B·∫Øt ƒë·∫ßu (t·∫°o c√¢u h·ªèi m·ªõi)
    document.getElementById("startGame").onclick = async () => {
      if (!currentRoom) return alert("Ch∆∞a c√≥ ph√≤ng");
      // T·∫°o ph√©p to√°n ng·∫´u nhi√™n
      let a, b;
      do {
        a = Math.floor(Math.random() * 6);
        b = Math.floor(Math.random() * 6);
      } while (a === b);
      const text = `${a} + ${b} = ?`;
      const ans = a + b;
      await update(ref(db, "rooms/" + currentRoom), {
        started: true,
        winner: "",
        question: { text, ans }
      });
    };

    // B·∫•m chu√¥ng
    document.getElementById("buzzBtn").onclick = async () => {
      if (!canBuzz) return;
      canBuzz = false;
      document.getElementById("buzzBtn").disabled = true;
      // Delay 3 gi√¢y tr∆∞·ªõc khi ch·∫•p nh·∫≠n
      setTimeout(async () => {
        // Ghi nh·∫≠n ng∆∞·ªùi b·∫•m
        const roomRef = ref(db, "rooms/" + currentRoom);
        const snap = await get(roomRef);
        const data = snap.val();
        if (data && !data.winner) {
          await update(roomRef, { winner: playerName });
        }
      }, 3000);
    };

    // Hi·ªÉn th·ªã popup c√¢u h·ªèi
    function showQuestion(text) {
      document.getElementById("questionText").innerText = text;
      document.getElementById("questionPopup").style.display = "block";
    }

    // N·ªôp c√¢u tr·∫£ l·ªùi
    document.getElementById("submitAnswer").onclick = () => {
      const val = parseInt(document.getElementById("answerInput").value);
      if (val === correctAnswer) {
        alert("ƒê√∫ng!");
      } else {
        alert("Sai!");
      }
      document.getElementById("questionPopup").style.display = "none";
    };
  </script>
</body>
</html>
