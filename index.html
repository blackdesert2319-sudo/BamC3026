<!DOCTYPE html>
<html>
<head>
    <title>Ứng dụng Bấm Chuông</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
            background-color: #f0f0f0;
        }
        .screen {
            display: none;
        }
        #initial-screen {
            display: block;
        }
        .button-container {
            margin-top: 50px;
        }
        .bell-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: #ff4d4d; /* Red color */
            border: none;
            box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            outline: none;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        .bell-button:active {
            transform: translateY(4px);
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
        }
        .bell-button.disabled {
            background-color: #ccc; /* Gray color */
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            cursor: not-allowed;
        }
        .bell-button.ringing {
            animation: ring-animation 0.3s infinite alternate;
        }
        @keyframes ring-animation {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        #winner-display {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div id="initial-screen" class="screen">
    <h1>Ứng dụng Bấm Chuông</h1>
    <p>Nhập tên và số người để tham gia</p>
    <label for="playerName">Tên của bạn:</label><br>
    <input type="text" id="playerName" name="playerName"><br><br>
    
    <label for="groupSize">Số người chơi trong nhóm:</label><br>
    <input type="number" id="groupSize" name="groupSize" value="2" min="2"><br><br>

    <button id="joinButton">Tham gia</button>
</div>

<div id="loading-screen" class="screen">
    <div id="loading-text" style="font-size: 20px; font-weight: bold; margin-top: 50px;">Đang ghép nhóm...</div>
</div>

<div id="game-screen" class="screen">
    <div id="winner-display"></div>
    <div class="button-container">
        <button id="bellButton" class="bell-button">Bấm Chuông</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyDjhVqrW8avY2z2O5DyOBniE0IMbWGNQRo",
        authDomain: "bamchuong2026.firebaseapp.com",
        projectId: "bamchuong2026",
        storageBucket: "bamchuong2026.firebasestorage.app",
        messagingSenderId: "962555043612",
        appId: "1:962555043612:web:271885084f96c9c088a4d9",
        measurementId: "G-W1ZHMRW2WL"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const initialScreen = document.getElementById('initial-screen');
    const gameScreen = document.getElementById('game-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const loadingText = document.getElementById('loading-text');
    const joinButton = document.getElementById('joinButton');
    const playerNameInput = document.getElementById('playerName');
    const groupSizeInput = document.getElementById('groupSize');
    const bellButton = document.getElementById('bellButton');
    const winnerDisplay = document.getElementById('winner-display');

    let myName = '';
    let groupRoomId = '';
    let groupSize = 0;
    
    // Play sound on click (bell ring)
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playSound() {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.3);
    }

    joinButton.addEventListener('click', () => {
        myName = playerNameInput.value;
        groupSize = parseInt(groupSizeInput.value);
        if (myName.trim() === '' || groupSize < 2) {
            alert('Vui lòng nhập tên và số người chơi hợp lệ.');
            return;
        }

        initialScreen.style.display = 'none';
        loadingScreen.style.display = 'block';
        loadingText.textContent = 'Đang ghép nhóm...';
        
        // Use a predictable room ID to ensure players find each other
        groupRoomId = 'room_' + groupSize;

        const roomRef = database.ref(`rooms/${groupRoomId}`);
        roomRef.once('value').then(snapshot => {
            const roomData = snapshot.val();
            let playersRef;

            if (roomData && roomData.groupSize === groupSize && (!roomData.players || Object.keys(roomData.players).length < groupSize)) {
                // Room exists and has space, join it
                playersRef = roomRef.child('players');
                playersRef.push({ name: myName, timestamp: Date.now() });
            } else {
                // Room doesn't exist or is full, create a new one
                roomRef.set({
                    groupSize: groupSize,
                    players: [{ name: myName, timestamp: Date.now() }],
                    gameActive: false,
                    winner: null
                });
                playersRef = roomRef.child('players');
            }

            // Listen for changes in the room
            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) {
                    resetGame();
                    return;
                }
                
                const playerCount = room.players ? Object.keys(room.players).length : 0;
                
                if (playerCount >= room.groupSize && !room.gameActive) {
                    loadingScreen.style.display = 'none';
                    gameScreen.style.display = 'block';
                    roomRef.child('gameActive').set(true);
                    winnerDisplay.textContent = 'Sẵn sàng! Bấm chuông giành quyền trả lời';
                }

                if (room.winner) {
                    if (room.winner.name === myName) {
                        winnerDisplay.textContent = 'Bạn đã thắng!';
                        bellButton.classList.add('ringing');
                        playSound(); // Play sound only for the winner
                    } else {
                        winnerDisplay.textContent = `Người thắng: ${room.winner.name}`;
                        bellButton.classList.add('disabled');
                    }

                    setTimeout(() => {
                        roomRef.child('winner').set(null);
                    }, 3000);
                } else {
                    bellButton.classList.remove('disabled');
                    bellButton.classList.remove('ringing');
                    if (gameScreen.style.display === 'block') {
                        winnerDisplay.textContent = 'Sẵn sàng! Bấm chuông giành quyền trả lời';
                    }
                }
            });
        });
    });

    bellButton.addEventListener('click', () => {
        if (!bellButton.classList.contains('disabled')) {
            const winnerRef = database.ref(`rooms/${groupRoomId}/winner`);
            winnerRef.set({ name: myName, timestamp: Date.now() });
        }
    });

    function resetGame() {
        initialScreen.style.display = 'block';
        gameScreen.style.display = 'none';
        loadingScreen.style.display = 'none';
    }
</script>
</body>
</html>

