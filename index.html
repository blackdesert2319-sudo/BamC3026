<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ai Nhanh H∆°n ‚Äî B·∫•m Chu√¥ng (C1)</title>
  <style>
    :root{--bg:#071028;--card:#0b1224;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--warn:#f59e0b;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#061426,#08102a);font-family:Inter,system-ui,Segoe UI,Roboto;color:var(--text);display:flex;align-items:center;justify-content:center;padding:18px;min-height:100vh}
    .app{width:min(1100px,98vw);background:rgba(2,6,23,0.6);border-radius:12px;border:1px solid #122033;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.6)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #10243a}
    header h1{margin:0;font-size:18px}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:18px}
    .card{background:linear-gradient(180deg, rgba(4,8,20,0.6), rgba(6,10,24,0.4)); border:1px solid #122033; border-radius:10px; padding:12px}
    label{display:block;color:var(--muted);margin-bottom:6px}
    input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #193047;background:#041224;color:var(--text)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid #143447;background:#072b3f;color:var(--text);cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#0ea5e9);color:white;border:none}
    .btn.success{background:linear-gradient(180deg,#16a34a,#22c55e);color:white;border:none}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706);color:black;border:none}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);color:white;border:none}
    .muted{color:var(--muted);font-size:13px}
    .playerList{max-height:340px;overflow:auto;margin-top:8px;border-radius:8px;border:1px dashed #0f3b58;padding:6px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px dashed #072235}
    .row:last-child{border-bottom:none}
    .center{text-align:center}
    .buzzer{width:100%;padding:30px;border-radius:16px;font-size:28px;font-weight:900;cursor:pointer;background:linear-gradient(180deg,#ef4444,#991b1b);box-shadow:0 18px 0 #7f1d1d;color:white;border:none}
    .buzzer.disabled{filter:grayscale(.7) brightness(.7);cursor:not-allowed}
    .hidden{display:none!important}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#07142a;border:1px solid #132a3f;padding:10px 14px;border-radius:10px}
    #popup{display:flex;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,0.7)}
    #popup .box{background:#041224;padding:18px;border-radius:12px;border:1px solid #0f3b58;width:min(460px,92vw);text-align:center}
    .small{font-size:13px;padding:6px 8px;border-radius:8px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>‚ö° Ai Nhanh H∆°n ‚Äî B·∫•m Chu√¥ng (GV b·∫•m START)</h1>
      <div id="roomTag" class="muted">‚Äî</div>
    </header>

    <main>
      <!-- left: login / host controls -->
      <div>
        <div class="card" id="loginCard">
          <label for="nameInput">T√™n (Nh·∫≠p t√™n, h·ªá th·ªëng s·∫Ω th√™m s·ªë n·∫øu tr√πng)</label>
          <input id="nameInput" type="text" placeholder="V√≠ d·ª•: Minh" />
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="btnCreate" class="btn success">T·∫†O PH√íNG (GV)</button>
            <button id="btnJoin" class="btn primary">V√ÄO PH√íNG (HS)</button>
          </div>
          <p class="muted" style="margin-top:10px">‚Ä¢ GV ph·∫£i b·∫•m <strong>B·∫ÆT ƒê·∫¶U</strong> ƒë·ªÉ m·ªü l∆∞·ª£t. ‚Ä¢ M·ªói l∆∞·ª£t c√≥ 1 ph√©p to√°n chung.</p>
        </div>

        <div class="card hidden" id="hostCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div><strong>M√£ ph√≤ng:</strong> <span id="hostCode">‚Äî</span></div>
              <div class="muted" id="hostStatus">V√≤ng: ‚Äî</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="btnStart" class="btn primary">B·∫ÆT ƒê·∫¶U</button>
              <button id="btnReset" class="btn">RESET</button>
            </div>
          </div>

          <hr style="margin:10px 0;border:none;border-top:1px solid #0e2233" />

          <div style="display:flex;gap:8px;align-items:center">
            <div><strong>Ng∆∞·ªùi ƒëang tr·∫£ l·ªùi:</strong> <span id="currentAnswerer">‚Äî</span></div>
            <div style="margin-left:auto;display:flex;gap:8px">
              <button id="btnCorrect" class="btn success">‚úÖ ƒê√öNG</button>
              <button id="btnWrong" class="btn warn">‚ùå SAI (mini-round)</button>
              <button id="btnEnd" class="btn danger">‚õî K·∫æT TH√öC C√ÇU</button>
            </div>
          </div>

          <hr style="margin:10px 0;border:none;border-top:1px solid #0e2233" />

          <div><strong>Danh s√°ch h·ªçc sinh:</strong>
            <div id="playerList" class="playerList"></div>
          </div>

          <div style="margin-top:10px">
            <strong>L·ªãch s·ª≠:</strong>
            <div id="history" class="playerList"></div>
          </div>
        </div>
      </div>

      <!-- right: player screen -->
      <div>
        <div class="card" id="playerCard" style="min-height:420px;">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="muted">B·∫°n l√†:</div>
              <div id="meName" style="font-weight:800">‚Äî</div>
            </div>
            <div class="center">
              <div class="muted">Tr·∫°ng th√°i v√≤ng</div>
              <div id="stateTag" style="font-weight:900">‚Äî</div>
            </div>
            <div class="center">
              <div class="muted">Ng∆∞·ªùi th·∫Øng (n·∫øu c√≥)</div>
              <div id="winnerName" style="font-weight:900">‚Äî</div>
            </div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid #0e2233" />

          <div id="playerArea" class="center" style="gap:12px">
            <div id="readyArea">
              <button id="btnBuzzer" class="buzzer">CHU√îNG</button>
              <div class="muted">Ch·ªù GV b·∫•m B·∫ÆT ƒê·∫¶U ƒë·ªÉ m·ªü l∆∞·ª£t.</div>
            </div>

            <div id="answeringArea" class="hidden">
              <div style="font-weight:800">‚è≥ Ng∆∞·ªùi ƒëang tr·∫£ l·ªùi: <span id="answeringWho">‚Äî</span></div>
              <div class="muted">GV s·∫Ω b·∫•m ƒê√öNG / SAI</div>
            </div>

            <div id="finalArea" class="hidden">
              <div id="finalText" style="font-size:20px;font-weight:900"></div>
              <div class="muted">Ch·ªù GV b·∫•m RESET ƒë·ªÉ c√¢u m·ªõi.</div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
            <button id="btnLeave" class="btn small">R·ªùi ph√≤ng</button>
            <button id="btnRefresh" class="btn small">L√†m m·ªõi</button>
          </div>
        </div>

        <div id="toast" class="toast hidden"></div>
      </div>
    </main>
  </div>

  <!-- popup question (hidden) -->
  <div id="popup" class="hidden" aria-hidden="true">
    <div class="box">
      <h2 id="questionText" style="font-size:28px;margin:0 0 12px 0">2 + 3 = ?</h2>
      <input id="answerInput" type="number" style="font-size:20px;padding:8px;width:120px;text-align:center;border-radius:8px;border:1px solid #0f3b58;background:#021826;color:var(--text)" />
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button id="btnSubmitAnswer" class="btn success">X√ÅC NH·∫¨N</button>
        <button id="btnCancelAnswer" class="btn">H·ª¶Y</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDK (d·ªÖ copy) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ====== C·∫§U H√åNH FIREBASE: thay b·∫±ng c·∫•u h√¨nh c·ªßa b·∫°n ======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ====== H·∫∞NG S·ªê ======
    const ROOM = 'room-demo-1'; // b·∫°n c√≥ th·ªÉ thay th√†nh m√£ ph√≤ng ƒë·ªông n·∫øu mu·ªën
    const stateRef = db.ref(`rooms/${ROOM}/state`);
    const playersRef = db.ref(`rooms/${ROOM}/players`);
    const historyRef = db.ref(`rooms/${ROOM}/history`);

    // ====== UI helpers ======
    const $ = id => document.getElementById(id);
    const toast = (t) => {
      const el = $('toast'); el.textContent = t; el.classList.remove('hidden'); clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> el.classList.add('hidden'), 2200);
    };

    // ====== Local store ======
    const local = { me: null, room: ROOM, isHost: false };

    // ====== T·∫°o ph√≤ng (GV) ======
    $('btnCreate').addEventListener('click', async () => {
      let name = ($('nameInput').value || 'Gi√°o vi√™n').trim();
      const id = crypto.randomUUID();
      // init room structure
      await db.ref(`rooms/${ROOM}`).set({
        createdAt: Date.now(),
        hostId: id,
        hostName: name,
        state: {
          round: 0,
          canBuzz: false,
          question: null,
          winnerId: null,
          winnerName: null,
          currentPlayer: null,
          excluded: {}
        },
        players: {}
      });
      // add host as player
      name = await assignUniqueName(name);
      await db.ref(`rooms/${ROOM}/players/${id}`).set({ id, name, online: true });
      local.me = { id, name }; local.isHost = true; saveLocal();
      $('hostCode').textContent = ROOM;
      $('roomTag').textContent = ROOM;
      showHostUI();
      bindHost();
      bindStateListener();
      toast('ƒê√£ t·∫°o ph√≤ng (GV)');
    });

    // ====== Vao phong (HS) ======
    $('btnJoin').addEventListener('click', async () => {
      let name = ($('nameInput').value || 'H·ªçc sinh').trim();
      const roomSnap = await db.ref(`rooms/${ROOM}`).get();
      if (!roomSnap.exists()) { toast('Ph√≤ng ch∆∞a t·ªìn t·∫°i ‚Äî GV c·∫ßn t·∫°o tr∆∞·ªõc'); return; }
      name = await assignUniqueName(name);
      const id = crypto.randomUUID();
      await db.ref(`rooms/${ROOM}/players/${id}`).set({ id, name, online: true });
      local.me = { id, name }; local.isHost = false; saveLocal();
      showPlayerUI();
      bindPlayer();
      bindStateListener();
      toast(`V√†o ph√≤ng v·ªõi t√™n ${name}`);
    });

    // ====== Name uniqueness (add numeric suffix if needed) ======
    async function assignUniqueName(desired) {
      const snap = await db.ref(`rooms/${ROOM}/players`).get();
      const list = snap.exists() ? snap.val() : {};
      let maxIndex = 0;
      Object.values(list).forEach(p => {
        if (!p || !p.name) return;
        if (p.name === desired) maxIndex = Math.max(maxIndex, 1);
        const m = (p.name + '').match(new RegExp(`^${escapeRegExp(desired)} (\\d+)$`));
        if (m) maxIndex = Math.max(maxIndex, Number(m[1]));
      });
      if (maxIndex === 0) return desired;
      return `${desired} ${maxIndex + 1}`;
    }
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    // ====== Save/load local ======
    function saveLocal(){ localStorage.setItem('buzzer_local', JSON.stringify(local)); }
    function loadLocal(){ try { const d=JSON.parse(localStorage.getItem('buzzer_local')||'{}'); if (d.me) local.me=d.me; if (d.isHost) local.isHost=d.isHost; } catch{} }
    loadLocal();
    if (local.me && local.isHost) { $('hostCode').textContent = ROOM; $('roomTag').textContent = ROOM; showHostUI(); bindHost(); bindStateListener(); }
    if (local.me && !local.isHost) { showPlayerUI(); bindPlayer(); bindStateListener(); }

    // ====== UI show/hide ======
    function showHostUI(){ $('loginCard').classList.add('hidden'); $('hostCard').classList.remove('hidden'); $('playerCard').classList.remove('hidden'); $('meName').textContent = local.me?.name || '‚Äî'; }
    function showPlayerUI(){ $('loginCard').classList.add('hidden'); $('hostCard').classList.add('hidden'); $('playerCard').classList.remove('hidden'); $('meName').textContent = local.me?.name || '‚Äî'; }

    // ====== Host controls ======
    function bindHost(){
      $('btnStart').onclick = async () => {
        // increment round, generate question, clear excluded, open buzz
        const a = Math.floor(Math.random()*6);
        let b; do { b = Math.floor(Math.random()*6); } while (b === a);
        await stateRef.transaction(s => {
          if (!s) s = {};
          s.round = (s.round || 0) + 1;
          s.canBuzz = true;
          s.question = { a, b };
          s.winnerId = null;
          s.winnerName = null;
          s.currentPlayer = null;
          s.excluded = {}; // clear exclusions for new round
          return s;
        });
        toast(`B·∫Øt ƒë·∫ßu v√≤ng ${ (await stateRef.child('round').get()).val() || '?' } ‚Äî C√¢u: ${a} + ${b}`);
      };

      $('btnReset').onclick = async () => {
        if (!confirm('RESET: k·∫øt th√∫c c√¢u, x√≥a k·∫øt qu·∫£ hi·ªán t·∫°i?')) return;
        await stateRef.update({ canBuzz: false, question: null, winnerId: null, winnerName: null, currentPlayer: null, excluded: {} });
        toast('ƒê√£ RESET ‚Äî chu·∫©n b·ªã cho c√¢u m·ªõi (GV b·∫•m B·∫ÆT ƒê·∫¶U)');
      };

      $('btnCorrect').onclick = async () => {
        const sSnap = await stateRef.get();
        const s = sSnap.val() || {};
        if (!s.winnerId) { toast('Ch∆∞a c√≥ ng∆∞·ªùi th·∫Øng ƒë·ªÉ x√°c nh·∫≠n'); return; }
        // push history
        await historyRef.push({ round: s.round || 0, winnerId: s.winnerId, winnerName: s.winnerName, at: Date.now() });
        // lock until GV reset
        await stateRef.update({ canBuzz: false });
        toast(`X√°c nh·∫≠n ƒê√öNG: ${s.winnerName}`);
      };

      $('btnWrong').onclick = async () => {
        // n·∫øu kh√¥ng c√≥ winner, but maybe current player - get that
        const sSnap = await stateRef.get();
        const s = sSnap.val() || {};
        const loserId = s.winnerId || s.currentPlayer;
        if (!loserId) { toast('Ch∆∞a c√≥ ng∆∞·ªùi ƒë·ªÉ lo·∫°i'); return; }
        // mark excluded for this round
        const upd = {};
        upd[`players/${loserId}/eliminated_${s.round || 0}`] = true;
        // mark excluded in state too
        await db.ref(`rooms/${ROOM}/state/excluded/${loserId}`).set(true);
        // clear winner/currentPlayer and generate new question and open canBuzz true
        const a = Math.floor(Math.random()*6);
        let b; do { b = Math.floor(Math.random()*6); } while (b === a);
        await stateRef.update({ winnerId: null, winnerName: null, currentPlayer: null, question: { a,b }, canBuzz: true });
        toast(`ƒê√£ lo·∫°i ng∆∞·ªùi ch∆°i. M·ªü mini-round m·ªõi (C√¢u: ${a} + ${b})`);
      };

      $('btnEnd').onclick = async () => {
        if (!confirm('K·∫øt th√∫c c√¢u n√†y kh√¥ng ch·ªçn ng∆∞·ªùi th·∫Øng?')) return;
        await stateRef.update({ canBuzz: false, question: null, winnerId: null, winnerName: null, currentPlayer: null });
        toast('C√¢u k·∫øt th√∫c b·ªüi GV.');
      };
    }

    // ====== Player side ======
    function bindPlayer(){
      // buzzer click: if canBuzz true and not excluded, open popup for question for this player
      $('btnBuzzer').onclick = async () => {
        if (!local.me) { toast('B·∫°n ch∆∞a v√†o ph√≤ng'); return; }
        const sSnap = await stateRef.get();
        const s = sSnap.val();
        if (!s || !s.canBuzz) { toast('Ch∆∞a m·ªü l∆∞·ª£t ‚Äî ch·ªù GV b·∫•m B·∫ÆT ƒê·∫¶U'); return; }
        // check excluded
        if (s.excluded && s.excluded[local.me.id]) { toast('B·∫°n ƒë√£ b·ªã lo·∫°i v√≤ng n√†y'); return; }
        // open popup with question from state
        const q = s.question;
        if (!q) { toast('C√¢u ch∆∞a s·∫µn s√†ng'); return; }
        $('questionText').textContent = `${q.a} + ${q.b} = ?`;
        $('answerInput').value = '';
        $('popup').classList.remove('hidden'); $('popup').setAttribute('aria-hidden','false');
        // store question to verify on submit
        window._activeQuestion = q;
      };

      $('btnCancelAnswer').onclick = () => { $('popup').classList.add('hidden'); $('popup').setAttribute('aria-hidden','true'); window._activeQuestion = null; };

      $('btnSubmitAnswer').onclick = async () => {
        const q = window._activeQuestion;
        if (!q) return;
        const val = parseInt($('answerInput').value);
        $('popup').classList.add('hidden'); $('popup').setAttribute('aria-hidden','true'); window._activeQuestion = null;
        if (Number.isNaN(val)) { toast('Nh·∫≠p ƒë√°p √°n h·ª£p l·ªá'); return; }
        if (val !== (q.a + q.b)) {
          // sai ‚Üí nothing else; teacher may decide; we just show feedback
          toast('Sai ƒë√°p √°n ‚Äî b·∫°n kh√¥ng ƒë∆∞·ª£c quy·ªÅn l·∫ßn n√†y');
          // Optionally mark elimination? Better left to GV via ‚ùå button
          return;
        }
        // ƒë√∫ng ‚Üí c·ªë g·∫Øng set winner via transaction: ch·ªâ 1 ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë∆∞·ª£c ghi winner
        try {
          await stateRef.transaction(s => {
            if (!s) return s;
            // if already has winner -> do nothing
            if (s.winnerId) return s;
            // also if this player was excluded (race) -> do nothing
            if (s.excluded && s.excluded[local.me.id]) return s;
            // set winner
            s.winnerId = local.me.id;
            s.winnerName = local.me.name;
            s.canBuzz = false; // lock further buzz until GV handles (or until mini-round)
            return s;
          }, (error, committed, snapshot) => {
            if (error) {
              console.error('Transaction error', error);
              toast('L·ªói khi x√°c nh·∫≠n c√¢u tr·∫£ l·ªùi');
            } else if (!committed) {
              toast('ƒê√£ c√≥ ng∆∞·ªùi kh√°c tr·∫£ l·ªùi ƒë√∫ng tr∆∞·ªõc b·∫°n');
            } else {
              toast('B·∫°n tr·∫£ l·ªùi ƒë√∫ng ‚Äî ƒë√£ ghi nh·∫≠n (ch·ªù GV x√°c nh·∫≠n)');
            }
          }, false);
        } catch(e) {
          console.error(e); toast('L·ªói khi submit ƒë√°p √°n');
        }
      };

      // leave / refresh
      $('btnLeave').onclick = async () => {
        if (!local.me) return;
        await db.ref(`rooms/${ROOM}/players/${local.me.id}/online`).set(false);
        local.me = null; local.isHost = false; saveLocal();
        location.reload();
      };
      $('btnRefresh').onclick = () => location.reload();
    }

    // ====== State listener (both GV & HS) ======
    function bindStateListener(){
      stateRef.on('value', async snap => {
        const s = snap.val() || {};
        // update basic UI
        $('hostStatus').textContent = `V√≤ng: ${s.round || 0} ‚Äî ${s.canBuzz ? 'ƒêang m·ªü' : (s.winnerId ? 'ƒê√£ c√≥ ng∆∞·ªùi th·∫Øng' : 'ƒêang kho√°')}`;
        $('stateTag').textContent = s.canBuzz ? 'S·∫µn s√†ng b·∫•m' : (s.winnerId ? 'ƒê√£ c√≥ ng∆∞·ªùi th·∫Øng' : 'ƒêang kho√°');
        $('winnerName').textContent = s.winnerName || '‚Äî';

        // host view current answerer (from winnerId concept)
        $('currentAnswerer').textContent = s.winnerId ? (s.winnerName || s.winnerId) : '‚Äî';

        // player view
        if (local.me && !local.isHost) {
          // if winner exists -> show final
          if (s.winnerId) {
            $('finalArea').classList.remove('hidden'); $('finalText').textContent = `üèÜ ${s.winnerName || '‚Äî'}`;
            $('readyArea').classList.add('hidden'); $('answeringArea').classList.add('hidden');
            $('btnBuzzer').classList.add('disabled'); $('btnBuzzer').disabled = true;
          } else if (s.currentPlayer) {
            // show who is answering (if teacher allows currentPlayer via winnerId earlier we used winner concept; here currentPlayer not used)
            $('answeringArea').classList.remove('hidden'); $('answeringWho').textContent = s.currentPlayerName || s.currentPlayer || '‚Äî';
            $('readyArea').classList.add('hidden');
            $('btnBuzzer').classList.add('disabled'); $('btnBuzzer').disabled = true;
          } else if (s.canBuzz && !(s.excluded && s.excluded[local.me.id])) {
            $('readyArea').classList.remove('hidden'); $('btnBuzzer').classList.remove('disabled'); $('btnBuzzer').disabled = false;
            $('answeringArea').classList.add('hidden'); $('finalArea').classList.add('hidden');
          } else {
            $('readyArea').classList.remove('hidden'); $('answeringArea').classList.add('hidden'); $('finalArea').classList.add('hidden');
            $('btnBuzzer').classList.add('disabled'); $('btnBuzzer').disabled = true;
          }
        }

        // update player list + show excluded marker
        const playersSnap = await playersRef.get();
        const players = playersSnap.exists() ? playersSnap.val() : {};
        renderPlayerList(players, s.excluded || {});
        // update history view
        const hSnap = await historyRef.get();
        const hist = hSnap.exists() ? hSnap.val() : {};
        renderHistory(hist);
      });
    }

    function renderPlayerList(players, excludedMap){
      const box = $('playerList'); box.innerHTML = '';
      Object.values(players || {}).forEach(p => {
        const r = document.createElement('div'); r.className='row';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:800">${p.name}</div><div class="muted" style="font-size:12px">${p.online ? 'online' : 'offline'}</div>`;
        const right = document.createElement('div'); right.innerHTML = `${excludedMap && excludedMap[p.id] ? '<span style="color:var(--warn)">B·ªã lo·∫°i</span>' : '<span class="muted">'+p.id.slice(-4)+'</span>'}`;
        r.appendChild(left); r.appendChild(right); box.appendChild(r);
      });
    }
    function renderHistory(hist){
      const box = $('history'); box.innerHTML = '';
      Object.values(hist || {}).reverse().slice(0,30).forEach(h => {
        const r = document.createElement('div'); r.className='row';
        r.innerHTML = `<div>${h.winnerName || '‚Äî'}</div><div class="muted" style="font-size:12px">${new Date(h.at).toLocaleTimeString('vi-VN')}</div>`;
        box.appendChild(r);
      });
    }

    // ====== Misc: restore session UI if local info present ======
    window.addEventListener('load', async () => {
      if (local.me) {
        $('meName').textContent = local.me.name;
        if (local.isHost) { showHostUI(); bindHost(); bindStateListener(); }
        else { showPlayerUI(); bindPlayer(); bindStateListener(); }
      } else {
        // default view: login shown
      }
    });
  </script>
</body>
</html>
