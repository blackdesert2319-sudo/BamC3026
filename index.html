<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Game Báº¥m ChuÃ´ng</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    .hidden { display: none; }
    button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    #status { margin: 20px; font-size: 20px; font-weight: bold; }
    #questionBox { font-size: 24px; margin: 20px; }
  </style>
</head>
<body>
  <h1>ğŸ“¢ Game Báº¥m ChuÃ´ng</h1>

  <div id="roleSelect">
    <button onclick="chooseRole('teacher')">TÃ´i lÃ  GiÃ¡o viÃªn</button>
    <button onclick="chooseRole('student')">TÃ´i lÃ  Há»c sinh</button>
  </div>

  <!-- GiÃ¡o viÃªn -->
  <div id="teacherUI" class="hidden">
    <h2>ğŸ‘©â€ğŸ« GiÃ¡o viÃªn</h2>
    <button onclick="createRoom()">Táº¡o phÃ²ng</button>
    <input id="teacherRoomId" placeholder="MÃ£ phÃ²ng" readonly>
    <div id="teacherControls" class="hidden">
      <button onclick="startRound()">Báº®T Äáº¦U</button>
      <button onclick="markCorrect()">âœ… ÄÃºng</button>
      <button onclick="markWrong()">âŒ Sai</button>
      <button onclick="resetGame()">RESET</button>
      <div id="status"></div>
    </div>
  </div>

  <!-- Há»c sinh -->
  <div id="studentUI" class="hidden">
    <h2>ğŸ‘¨â€ğŸ“ Há»c sinh</h2>
    <input id="roomInput" placeholder="Nháº­p mÃ£ phÃ²ng">
    <input id="playerName" placeholder="TÃªn cá»§a báº¡n">
    <button onclick="joinRoom()">VÃ o phÃ²ng</button>
    <div id="studentControls" class="hidden">
      <button id="buzzBtn" onclick="buzz()">ğŸ”” Báº¥m ChuÃ´ng</button>
      <div id="questionBox"></div>
      <div id="status"></div>
    </div>
  </div>

  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update, push, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    // Cáº¥u hÃ¬nh Firebase cá»§a báº¡n
    const firebaseConfig = {
      apiKey: "AIzaSyAAdt8pjiOTBCFuDEv_1BWZlPQYtJBWdZY",
      authDomain: "appchuong-c3fb8.firebaseapp.com",
      projectId: "appchuong-c3fb8",
      storageBucket: "appchuong-c3fb8.firebasestorage.app",
      messagingSenderId: "794046720932",
      appId: "1:794046720932:web:8fe3166394b7e366dbaf31",
      measurementId: "G-1W7BYFTQNX",
      databaseURL: "https://appchuong-c3fb8-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let role = null;
    let currentRoomId = null;
    let playerId = null;
    let playerName = null;

    // Chá»n vai trÃ²
    window.chooseRole = (r) => {
      role = r;
      document.getElementById("roleSelect").classList.add("hidden");
      if (r === "teacher") {
        document.getElementById("teacherUI").classList.remove("hidden");
      } else {
        document.getElementById("studentUI").classList.remove("hidden");
      }
    };

    // GiÃ¡o viÃªn táº¡o phÃ²ng
    window.createRoom = () => {
      const roomId = Math.floor(1000 + Math.random() * 9000).toString();
      set(ref(db, "rooms/" + roomId), {
        state: {
          canBuzz: false,
          winnerId: null,
          winnerName: null,
          question: null,
          currentPlayer: null
        },
        players: {}
      });
      currentRoomId = roomId;
      document.getElementById("teacherRoomId").value = roomId;
      document.getElementById("teacherControls").classList.remove("hidden");
      listenRoom(roomId);
    };

    // Há»c sinh vÃ o phÃ²ng
    window.joinRoom = async () => {
      const roomId = document.getElementById("roomInput").value.trim();
      const name = document.getElementById("playerName").value.trim();
      if (!roomId || !name) return alert("Nháº­p mÃ£ phÃ²ng vÃ  tÃªn");

      const snap = await get(ref(db, "rooms/" + roomId));
      if (!snap.exists()) return alert("PhÃ²ng khÃ´ng tá»“n táº¡i");

      currentRoomId = roomId;
      playerId = push(child(ref(db), "tmp")).key;

      // Xá»­ lÃ½ trÃ¹ng tÃªn
      const players = snap.val().players || {};
      let finalName = name;
      let count = 0;
      Object.values(players).forEach(p => {
        if (p.name.startsWith(name)) count++;
      });
      if (count > 0) finalName = `${name} ${count + 1}`;
      playerName = finalName;

      await set(ref(db, "rooms/" + roomId + "/players/" + playerId), {
        name: playerName
      });

      document.getElementById("studentControls").classList.remove("hidden");
      listenRoom(roomId);
    };

    // GiÃ¡o viÃªn báº¯t Ä‘áº§u vÃ²ng
    window.startRound = () => {
      if (!currentRoomId) return;
      const a = Math.floor(Math.random() * 6);
      let b;
      do { b = Math.floor(Math.random() * 6); } while (b === a);

      update(ref(db, "rooms/" + currentRoomId + "/state"), {
        canBuzz: true,
        winnerId: null,
        winnerName: null,
        currentPlayer: null,
        question: { a, b }
      });
    };

    // Há»c sinh báº¥m chuÃ´ng
    window.buzz = () => {
      if (!currentRoomId || !playerId) return;
      const questionRef = ref(db, "rooms/" + currentRoomId + "/state/question");
      get(questionRef).then(snap => {
        if (!snap.exists()) return;
        const q = snap.val();
        const ans = prompt(`${q.a} + ${q.b} = ?`);
        if (ans && parseInt(ans) === q.a + q.b) {
          const stateRef = ref(db, "rooms/" + currentRoomId + "/state");
          get(stateRef).then(s => {
            const st = s.val();
            if (st.canBuzz && !st.winnerId) {
              update(stateRef, {
                winnerId: playerId,
                winnerName: playerName,
                canBuzz: false,
                currentPlayer: playerId
              });
            }
          });
        } else {
          alert("Sai rá»“i!");
        }
      });
    };

    // GiÃ¡o viÃªn Ä‘Ã¡nh dáº¥u Ä‘Ãºng
    window.markCorrect = () => {
      if (!currentRoomId) return;
      document.getElementById("status").innerText = "âœ… CÃ¢u tráº£ lá»i Ä‘Ãºng!";
    };

    // GiÃ¡o viÃªn Ä‘Ã¡nh dáº¥u sai -> má»Ÿ mini round
    window.markWrong = () => {
      if (!currentRoomId) return;
      startRound(); // táº¡o phÃ©p toÃ¡n má»›i cho mini round
    };

    // GiÃ¡o viÃªn reset
    window.resetGame = () => {
      if (!currentRoomId) return;
      update(ref(db, "rooms/" + currentRoomId + "/state"), {
        canBuzz: false,
        winnerId: null,
        winnerName: null,
        currentPlayer: null,
        question: null
      });
      document.getElementById("status").innerText = "";
    };

    // Láº¯ng nghe phÃ²ng
    function listenRoom(roomId) {
      onValue(ref(db, "rooms/" + roomId + "/state"), snap => {
        if (!snap.exists()) return;
        const st = snap.val();

        // Hiá»ƒn thá»‹ cÃ¢u há»i cho há»c sinh
        if (role === "student") {
          const qb = document.getElementById("questionBox");
          if (st.question) {
            qb.innerText = `${st.question.a} + ${st.question.b} = ?`;
          } else {
            qb.innerText = "";
          }
        }

        // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i chung
        if (st.winnerName) {
          document.getElementById("status").innerText = `ğŸ† ${st.winnerName} chiáº¿n tháº¯ng!`;
        }
      });
    }
  </script>
</body>
</html>
